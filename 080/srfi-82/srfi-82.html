<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
  <title>SRFI 82: Stream Ports</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/srfi.css" type="text/css" />
</head>
<body>

<H1>Title</H1>

Stream Ports

<H1>Author</H1>

Michael Sperber

<H1>Status</H1>

This SRFI is currently in ``withdrawn'' status.  For an explanation of
each status that a SRFI can hold, see
<A HREF="http://srfi.schemers.org/srfi-process.html">here</A>.  You can
access the discussion via <A HREF="mail-archive/maillist.html">the
archive of the mailing list</A>.

<UL>
<LI>Received: 2005-10-08
<LI>Draft: 2005-11-24
<LI>Withdrawn: 2006-11-20
</UL>

<h1>Abstract</h1>
<p>This SRFI augments <a href="http://srfi.schemers.org/srfi-81/">SRFI 81 (Port I/O)</a> by allowing ports to be constructed from streams as described in <a href="http://srfi.schemers.org/srfi-80/">SRFI 80 (Stream I/O)</a>.</p><h1>Rationale</h1><p>Streams provide all the functionality necessary for implementing ports. Sometimes, a stream is available when a port is needed.  This SRFI describes an API for constructing ports from streams, and specifies their semantics in terms of it. The resulting semantics is completely consistent with the semantics of "standard" ports.  In fact, implementations may choose to implement <em>all</em> ports on top of streams.</p><h1>Specification</h1><h2>Prerequisites</h2><p>This SRFI is meant for Scheme implementations with support for SRFIs <a href="http://srfi.schemers.org/srfi-80/">SRFI 80 (Stream I/O)</a>, and <a href="http://srfi.schemers.org/srfi-81/">SRFI 81 (Port I/O)</a>.</p><h2>Stream ports</h2><p>These are the procedures that are specific to stream ports.</p><h3>Stream input ports</h3><dl><dt><code>(make-stream-input-port </code><var>input-stream</var><code>)</code></dt><dd><p>This creates a stream input port that points to <var>input-stream</var>.</p></dd><dt><code>(stream-input-port? </code><var>obj</var><code>)</code></dt><dd><p>This returns <code>#t</code> if the argument is a stream input port, <code>#f</code> otherwise.</p></dd><dt><code>(input-port-stream </code><var>stream-input-port</var><code>)</code></dt><dd><p>This returns the input stream underlying <var>stream-input-port</var>.</p></dd><dt><code>(set-input-port-stream! </code><var>stream-input-port</var> <var>input-stream</var><code>)</code></dt><dd><p>This sets the input stream underlying <var>stream-input-port</var> to <var>input-stream</var>.</p></dd></dl><h3>Stream output ports</h3><dl><dt><code>(make-stream-output-port </code><var>output-stream</var><code>)</code></dt><dd><p>This creates a stream output port that points to <var>output-stream</var>.</p></dd><dt><code>(stream-output-port? </code><var>obj</var><code>)</code></dt><dd><p>This returns <code>#t</code> if the argument is a stream output port, <code>#f</code> otherwise.</p></dd><dt><code>(output-port-stream </code><var>stream-output-port</var><code>)</code></dt><dd><p>This returns the output stream underlying <var>stream-output-port</var>.</p></dd><dt><code>(set-output-port-stream! </code><var>stream-output-port</var> <var>output-stream</var><code>)</code></dt><dd><p>This sets the output stream underlying <var>stream-output-port</var> to <var>output-stream</var>.</p></dd></dl><h2>Port Operations</h2><p>The following text describes how the operations on ports specified in <a href="http://srfi.schemers.org/srfi-81/">SRFI 81 (Port I/O)</a> operate on stream ports.  Thus, the descriptions here augment those in the Port I/O SRFI for the special case of stream-port arguments.</p><h3>Stream Input ports</h3><dl><dt><code>(read-blob-some </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-blob-some"><code>input-blob-some</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-blob-some</code>'s first return value.</p></dd><dt><code>(read-u8 </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-u8"><code>input-u8</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-u8</code>'s first return value.</p></dd><dt><code>(read-blob-n </code><var>input-port</var> <var>n</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-blob-n"><code>input-blob-n</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-blob-n</code>'s first return value.</p></dd><dt><code>(read-blob-n! </code><var>input-port</var> <var>blob</var> <var>start</var> <var>count</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-blob-n!"><code>input-blob-n!</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-blob-n!</code>'s first return value.</p></dd><dt><code>(read-blob-all </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-blob-all"><code>input-blob-all</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-blob-all</code>'s first return value.</p></dd><dt><code>(read-string </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-string"><code>input-string</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-string</code>'s first return value.</p></dd><dt><code>(read-char </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-char"><code>input-char</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-char</code>'s first return value.</p></dd><dt><code>(read-string-n </code><var>input-port</var> <var>n</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-string-n"><code>input-string-n</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-string-n</code>'s first return value.</p></dd><dt><code>(read-string-n! </code><var>input-port</var> <var>string</var> <var>start</var> <var>count</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-string-n!"><code>input-string-n!</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-string-n!</code>'s first return value.</p></dd><dt><code>(read-string-all </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-string-all"><code>input-string-all</code></a> on the underlying input stream, updates the underlying input stream to the second return value, and returns <code>input-string-all</code>'s first return value.</p></dd><dt><code>(peek-u8 </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-u8"><code>input-u8</code></a> on the underlying input stream, but does not update the underlying input stream.  It returns <code>input-u8</code>'s first return value.</p></dd><dt><code>(peek-char </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-char"><code>input-char</code></a> on the underlying input stream, but does not update the underlying input stream.  It returns <code>input-char</code>'s first return value.</p></dd><dt><code>(port-eof? </code><var>input-port</var><code>)</code></dt><dd><p>This returns the result of calling <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#stream-eof?"><code>stream-eof?</code></a> on the input stream underlying <var>input-port</var>.</p></dd><dt><code>(input-port-position </code><var>input-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#input-stream-position"><code>input-stream-position</code></a> on the underlying input stream and returns the result.</p></dd><dt><code>(set-input-port-position! </code><var>input-port</var> <var>pos</var><code>)</code></dt><dd><p>This extracts the underlying reader, sets its position, and sets the reader of the port to a new input stream constructed from the same reader.</p></dd><dt><code>(transcode-input-port! </code><var>input-port</var> <var>transcoder</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#transcode-input-stream"><code>transcode-input-stream</code></a> on the underlying stream and updates the port with the result.</p></dd><dt><code>(close-input-port </code><var>input-port</var><code>)</code></dt><dd><p>For a stream input port, this calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#close-input-stream"><code>close-input-stream</code></a> on the stream underlying <var>input-port</var>.</p></dd>
</dl>

<h3>Stream Output ports</h3><dl><dt><code>(write-blob </code><var>output-port</var> <var>blob</var><code>)</code></dt><dt><code>(write-blob </code><var>output-port</var> <var>blob</var> <var>start</var><code>)</code></dt><dt><code>(write-blob </code><var>output-port</var> <var>blob</var> <var>start</var> <var>count</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#output-blob"><code>output-blob</code></a> on the underlying output stream and <var>blob</var>, <code>start</code> and <code>count</code>.</p></dd></dl>
<dl><dt><code>(write-u8 </code><var>output-port</var> <var>octet</var><code>)</code></dt><dd><p>This calls <code>output-u8</code> on the underlying output stream and <var>u8</var>.  The return values are unspecified.</p></dd><dt><code>(write-string-n </code><var>output-port</var> <var>string</var><code>)</code></dt><dt><code>(write-string-n </code><var>output-port</var> <var>string</var> <var>start</var><code>)</code></dt><dt><code>(write-string-n </code><var>output-port</var> <var>string</var> <var>start</var> <var>count</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#output-string"><code>output-string</code></a> on the underlying output stream and <var>string</var>, <code>start</code> and <code>count</code>.</p></dd><dt><code>(write-char </code><var>output-port</var> <var>char</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#output-char"><code>output-char</code></a> on the underlying output stream and <var>char</var>.</p></dd><dt><code>(newline </code><var>output-port</var><code>)</code></dt><dd><p>This is equivalent to <code>(write-char #\newline <var>output-port</var>)</code>.  The return values are unspecified.</p></dd><dt><code>(flush-output-port </code><var>output-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#flush-output-stream"><code>flush-output-stream</code></a> on the underlying output stream.</p></dd><dt><code>(output-port-buffer-mode </code><var>output-port</var><code>)</code></dt><dd><p>For a stream output port, this calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#output-stream-buffer-mode"><code>output-stream-buffer-mode</code></a> on the underlying output stream.</p></dd><dt><code>(set-output-port-buffer-mode! </code><var>output-port</var> <var>buffer-mode</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#set-output-stream-buffer-mode!"><code>set-output-stream-buffer-mode!</code></a> on the underlying output stream.</p></dd><dt><code>(output-port-position </code><var>output-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#output-stream-position"><code>output-stream-position</code></a> on the underlying output stream and returns the result.</p></dd><dt><code>(set-output-port-position! </code><var>output-port</var> <var>pos</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#set-output-stream-position!"><code>set-output-stream-position!</code></a> on the underlying output stream with <var>pos</var> and returns whatever it returns.</p></dd><dt><code>(transcode-output-port! </code><var>output-port</var> <var>transcoder</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#transcode-output-stream"><code>transcode-output-stream</code></a> on the underlying stream and updates the port with the result.</p></dd><dt><code>(close-output-port </code><var>output-port</var><code>)</code></dt><dd><p>This calls <a href="http://srfi.schemers.org/srfi-80/srfi-80.html#close-output-stream"><code>close-output-stream</code></a> on the stream underlying <var>output-port</var>.</p></dd></dl>

<h1>Reference Implementation</h1><p><a href="https://srfi.schemers.org/srfi-79/srfi-79.tgz">Here</a> is a tarball containing a reference implementation of this SRFI.  It only runs on a version of Scheme 48 that has not been released at the time of writing in this SRFI.</p><p>However, its actual dependencies on Scheme 48 idiosyncracies are few.  Chief are its use of the module system, which is easily replaced by another, and the implementation of Unicode.  To implement primitive readers and writers on files, the code only relies on suitable library procedures to open the files, and <code>read-byte</code> and <code>write-byte</code> procedures to read or write single bytes from a (R5RS) port, as well as a <code>force-output</code> procedure to flush a port.</p><p>The reference implementation has not been highly tuned, but I have spent a modest amount of time making the code deal with buffers in an economic buffer.  Because of this, the code is more complicated than it needs to be, but hopefully also more usable as a basis for implementing this SRFI in actual Scheme systems.</p><h1>Acknowledgements</h1><p>Sebastian Egner provided valuable comments on a draft of this SRFI.</p><h1>References</h1><ul><li><a href="http://www.standardml.org/Basis/">The Standard ML Basis Library</a> edited by Emden R. Gansner and John H. Reppy.  Cambrige University Press, 2004.</li></ul><H1>Copyright</H1>
Copyright (C) Michael Sperber (2005). All Rights Reserved. 
<p>
Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files (the "Software"),
to deal in the Software without restriction, including without limitation
the rights to use, copy, modify, merge, publish, distribute, sublicense,
and/or sell copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following conditions:
<p>
The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.
<p>
THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
DEALINGS IN THE SOFTWARE.

    <hr>
    <address>Editor: <a href="mailto:srfi-editors at srfi dot schemers dot org">Donovan Kolbly</a></address>
</body></html>
